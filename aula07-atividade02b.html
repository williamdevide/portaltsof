<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evento 2b - An√°lise de Risco: E-commerce</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #0a192f;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(34, 197, 94, 0.1), transparent 30%),
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.1), transparent 30%);
            min-height: 100vh;
        }
        .card {
            background-color: rgba(17, 34, 64, 0.75);
            border: 1px solid rgba(34, 197, 94, 0.2);
            backdrop-filter: blur(10px);
        }
        .form-select {
            background-color: rgba(10, 25, 47, 0.8);
            border-color: rgba(34, 197, 94, 0.3);
            cursor: pointer;
        }
        .form-select:focus {
            background-color: rgba(10, 25, 47, 1);
            border-color: #22c55e;
            box-shadow: 0 0 0 0.25rem rgba(34, 197, 94, 0.25);
        }
        .log-entry.log-fail { border-left: 4px solid #ef4444; background-color: rgba(239, 68, 68, 0.1); }
        .log-entry.log-success { border-left: 4px solid #10b981; background-color: rgba(16, 185, 129, 0.1); }
        .table-dark { --bs-table-bg: rgba(10, 25, 47, 0.5); }
        .correct-guess { background-color: rgba(16, 185, 129, 0.5) !important; border-color: #10b981 !important; }
        .incorrect-guess { background-color: rgba(239, 68, 68, 0.5) !important; border-color: #ef4444 !important; }
    </style>
</head>
<body class="p-3 p-md-4">

    <div class="container-fluid">
        <main class="card p-4 p-lg-5 mx-auto" style="max-width: 1200px;">
            <header class="text-center mb-5 position-relative">
                <h1 class="display-5 fw-bold text-success">üèÜ An√°lise de Risco: E-commerce üèÜ</h1>
                <h2 class="h4 text-light">Evento de Teste de Regress√£o</h2>
                <p class="text-muted">Novas funcionalidades foram adicionadas ao sistema da loja. Analise o risco de regress√£o e encontre os bugs!</p>
                <button id="help-btn" class="btn btn-sm btn-outline-light position-absolute top-0 end-0 mt-2 me-2 rounded-circle" style="width: 30px; height: 30px; line-height: 1;">?</button>
            </header>

            <div>
                <!-- Se√ß√£o de An√°lise de Risco -->
                <div class="mb-5">
                    <div class="mb-4 p-3 rounded" style="background-color: rgba(10, 25, 47, 0.5);">
                        <h3 class="fw-bold fs-5 text-light">Relat√≥rio da Miss√£o:</h3>
                        <p class="text-muted mt-2">A equipa de desenvolvimento implementou as seguintes 5 novas funcionalidades. O seu trabalho √© analisar o impacto de cada uma delas nas funcionalidades j√° existentes do sistema.</p>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item bg-transparent text-light"><strong>M1 (Estoque):</strong> Controle de estoque por tamanho/cor. <em>Altera√ß√µes na estrutura fundamental de um item podem ter efeitos cascata.</em></li>
                            <li class="list-group-item bg-transparent text-light"><strong>M2 (Avalia√ß√µes):</strong> Sistema de avalia√ß√µes (reviews) de clientes. <em>Dados gerados por utilizadores podem influenciar a visibilidade e a ordena√ß√£o dos produtos.</em></li>
                            <li class="list-group-item bg-transparent text-light"><strong>M3 (Fornecedor):</strong> Campo de "Fornecedor" no cadastro. <em>Vincular um produto a outra entidade pode criar restri√ß√µes em seu ciclo de vida.</em></li>
                            <li class="list-group-item bg-transparent text-light"><strong>M4 (Moeda):</strong> Suporte a m√∫ltiplas moedas (D√≥lar, Euro). <em>A convers√£o de valores √© um ponto cr√≠tico que afeta principalmente a exibi√ß√£o de pre√ßos.</em></li>
                            <li class="list-group-item bg-transparent text-light"><strong>M5 (Categorias):</strong> Sistema de categorias aninhadas (Ex: Roupas > Camisetas). <em>A forma como os produtos s√£o agrupados afeta diretamente como s√£o mostrados ao utilizador final.</em></li>
                        </ul>
                    </div>

                    <h3 class="fw-bold fs-5 mb-3 text-light">Matriz de An√°lise de Risco de Regress√£o:</h3>
                    <div class="table-responsive">
                        <table class="table table-dark table-bordered align-middle text-center w-100" style="table-layout: fixed;">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 30%;">Funcionalidade Antiga</th>
                                    <th scope="col" style="width: 14%;">M1 (Estoque)</th>
                                    <th scope="col" style="width: 14%;">M2 (Avalia√ß√µes)</th>
                                    <th scope="col" style="width: 14%;">M3 (Fornecedor)</th>
                                    <th scope="col" style="width: 14%;">M4 (Moeda)</th>
                                    <th scope="col" style="width: 14%;">M5 (Categorias)</th>
                                </tr>
                            </thead>
                            <tbody id="risk-matrix-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Se√ß√£o de Objetivos -->
                <div class="mb-5">
                    <h3 class="fw-bold fs-5 text-light">Objetivos da An√°lise:</h3>
                    <div class="row g-3 text-center mt-2">
                        <div class="col"><div class="card p-2 h-100"><div class="card-body"><h5 class="fs-2 fw-bold text-danger" id="alta-count">0 / 9</h5><small class="text-muted">Riscos ALTA</small></div></div></div>
                        <div class="col"><div class="card p-2 h-100"><div class="card-body"><h5 class="fs-2 fw-bold text-warning" id="media-count">0 / 14</h5><small class="text-muted">Riscos M√âDIA</small></div></div></div>
                        <div class="col"><div class="card p-2 h-100"><div class="card-body"><h5 class="fs-2 fw-bold text-success" id="baixa-count">0 / 11</h5><small class="text-muted">Riscos BAIXA</small></div></div></div>
                        <div class="col"><div class="card p-2 h-100"><div class="card-body"><h5 class="fs-2 fw-bold text-secondary" id="nenhuma-count">0 / 6</h5><small class="text-muted">Riscos NENHUMA</small></div></div></div>
                    </div>
                </div>

                <!-- Se√ß√£o de Resultados -->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <h3 class="fw-bold fs-5 text-light">Painel do Detetive:</h3>
                        <div class="d-grid gap-3 mb-4">
                            <button id="analyze-button" class="btn btn-success btn-lg">Analisar Riscos e Encontrar os Bugs</button>
                        </div>
                        
                        <h3 class="fw-bold fs-5 text-light">Log de Investiga√ß√£o:</h3>
                        <div id="log" class="p-3 rounded" style="background-color: rgba(10, 25, 47, 0.5); min-height: 200px;"><p class="text-center text-muted">Aguardando an√°lise...</p></div>

                        <div id="report-section" class="d-none text-center mt-4">
                           <div class="card p-4">
                                <h3 class="text-light fs-4">Atividade Conclu√≠da!</h3>
                                <p class="text-muted">Sua pontua√ß√£o final foi de:</p>
                                <p class="display-4 fw-bold text-success" id="final-score">0</p>
                                <p class="text-muted">Gere um relat√≥rio em PDF com os seus resultados.</p>
                                <button id="generate-pdf-btn" class="btn btn-lg btn-success mt-2">Gerar Relat√≥rio (PDF)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Ajuda -->
    <div class="modal fade" id="helpModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content card"><div class="modal-header border-success-subtle"><h5 class="modal-title text-success">Como Jogar: An√°lise de Risco</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h5>üéØ Objetivo</h5><p>Analise o impacto de cada <strong>nova funcionalidade</strong> sobre cada <strong>funcionalidade antiga</strong> e preencha a matriz com a sua avalia√ß√£o de risco de regress√£o.</p><hr class="my-4"><h5>üíØ Pontua√ß√£o Final (0-100)</h5><ul><li><strong>An√°lise de Precis√£o (at√© 50 pts):</strong> Pontos por cada c√©lula da matriz preenchida corretamente.</li><li><strong>Identifica√ß√£o dos Bugs Principais (at√© 50 pts):</strong> Existem <strong>5 bugs principais</strong> escondidos (riscos "ALTO"). Voc√™ ganha <strong>10 pontos de b√¥nus</strong> por cada um que identificar.</li></ul></div></div></div></div>

    <!-- Bibliotecas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // --- CONFIGURA√á√ÉO DO JOGO ---
        const oldFeatures = [
            { id: 'F1', name: 'Cadastrar Novo Produto' }, { id: 'F2', name: 'Listar Todos os Produtos' },
            { id: 'F3', name: 'Buscar Produto por SKU' }, { id: 'F4', name: 'Editar Pre√ßo do Produto' },
            { id: 'F5', name: 'Ativar/Inativar Produto' }, { id: 'F6', name: 'Listar Produtos em Promo√ß√£o' },
            { id: 'F7', name: 'Deletar Produto' }, { id: 'F8', name: 'Aplicar Desconto em Massa' }
        ];
        const newFeatures = ['M1', 'M2', 'M3', 'M4', 'M5'];
        const riskLevels = ['NENHUMA', 'BAIXA', 'M√âDIA', 'ALTA'];
        const riskAnswerKey = {
            'F1': { 'M1': 'ALTA', 'M2': 'M√âDIA', 'M3': 'ALTA', 'M4': 'M√âDIA', 'M5': 'ALTA' },
            'F2': { 'M1': 'M√âDIA', 'M2': 'ALTA', 'M3': 'BAIXA', 'M4': 'BAIXA', 'M5': 'ALTA' },
            'F3': { 'M1': 'ALTA', 'M2': 'NENHUMA', 'M3': 'BAIXA', 'M4': 'NENHUMA', 'M5': 'BAIXA' },
            'F4': { 'M1': 'ALTA', 'M2': 'NENHUMA', 'M3': 'NENHUMA', 'M4': 'ALTA', 'M5': 'NENHUMA' },
            'F5': { 'M1': 'M√âDIA', 'M2': 'BAIXA', 'M3': 'BAIXA', 'M4': 'NENHUMA', 'M5': 'BAIXA' },
            'F6': { 'M1': 'M√âDIA', 'M2': 'ALTA', 'M3': 'BAIXA', 'M4': 'M√âDIA', 'M5': 'M√âDIA' },
            'F7': { 'M1': 'M√âDIA', 'M2': 'BAIXA', 'M3': 'ALTA', 'M4': 'NENHUMA', 'M5': 'M√âDIA' },
            'F8': { 'M1': 'M√âDIA', 'M2': 'M√âDIA', 'M3': 'BAIXA', 'M4': 'ALTA', 'M5': 'M√âDIA' }
        };
        const principalBugs = [
            { oldF: 'F1', newF: 'M1', description: 'M1 (Estoque) vs "Cadastrar Produto".' },
            { oldF: 'F2', newF: 'M5', description: 'M5 (Categorias) vs "Listar Todos os Produtos".' },
            { oldF: 'F4', newF: 'M4', description: 'M4 (Moeda) vs "Editar Pre√ßo do Produto".' },
            { oldF: 'F6', newF: 'M2', description: 'M2 (Avalia√ß√µes) vs "Listar Produtos em Promo√ß√£o".' },
            { oldF: 'F7', newF: 'M3', description: 'M3 (Fornecedor) vs "Deletar Produto".' }
        ];
        const totalRisks = { 'ALTA': 9, 'M√âDIA': 14, 'BAIXA': 11, 'NENHUMA': 6 };

        // --- ELEMENTOS DO DOM ---
        const riskMatrixBody = document.getElementById('risk-matrix-body');
        const analyzeButton = document.getElementById('analyze-button');
        const finalScoreEl = document.getElementById('final-score');
        const logEl = document.getElementById('log');
        const helpBtn = document.getElementById('help-btn');
        const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
        const reportSection = document.getElementById('report-section');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const counters = {
            'ALTA': document.getElementById('alta-count'), 'M√âDIA': document.getElementById('media-count'),
            'BAIXA': document.getElementById('baixa-count'), 'NENHUMA': document.getElementById('nenhuma-count')
        };
        
        // --- L√ìGICA DO JOGO ---
        function createRiskMatrix() {
            oldFeatures.forEach(oldFeature => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<th scope="row" class="text-light">${oldFeature.name}</th>`;
                newFeatures.forEach(newFeatureId => {
                    const td = document.createElement('td');
                    const select = document.createElement('select');
                    select.className = 'form-select form-select-sm';
                    select.dataset.old = oldFeature.id;
                    select.dataset.new = newFeatureId;
                    select.innerHTML = '<option value="" selected disabled>Selecione...</option>' + riskLevels.map(level => `<option value="${level}">${level}</option>`).join('');
                    td.appendChild(select);
                    tr.appendChild(td);
                });
                riskMatrixBody.appendChild(tr);
            });
        }
        
        analyzeButton.addEventListener('click', () => {
            let totalPoints = 0;
            const maxPoints = 40;
            let correctBugIdentifications = 0;
            const correctCounts = { 'ALTA': 0, 'M√âDIA': 0, 'BAIXA': 0, 'NENHUMA': 0 };
            logEl.innerHTML = '';

            document.querySelectorAll('#risk-matrix-body select').forEach(select => {
                const oldF_id = select.dataset.old, newF_id = select.dataset.new;
                const userAnswer = select.value, correctAnswer = riskAnswerKey[oldF_id][newF_id];
                select.disabled = true;
                if (!userAnswer) return;
                if (userAnswer === correctAnswer) {
                    totalPoints++;
                    select.classList.add('correct-guess');
                    correctCounts[correctAnswer]++;
                } else {
                    select.classList.add('incorrect-guess');
                }
            });
            
            principalBugs.forEach(bug => {
                const select = document.querySelector(`select[data-old='${bug.oldF}'][data-new='${bug.newF}']`);
                if (select && select.value === 'ALTA') {
                    correctBugIdentifications++;
                    registrarLog(`<strong class="text-success">BUG PRINCIPAL ENCONTRADO!</strong> Risco ALTO para: ${bug.description}`, 'success');
                } else {
                    registrarLog(`<strong class="text-danger">BUG PRINCIPAL PERDIDO!</strong> Falha ao identificar o risco ALTO para: ${bug.description}`, 'fail');
                }
            });

            const analysisScore = (totalPoints / maxPoints) * 50;
            const bugBonus = correctBugIdentifications * 10;
            const finalScore = Math.round(analysisScore + bugBonus);
            finalScoreEl.textContent = finalScore;
            analyzeButton.disabled = true;

            Object.keys(counters).forEach(key => counters[key].textContent = `${correctCounts[key]} / ${totalRisks[key]}`);
            registrarLog(`<strong class="text-info">An√°lise Conclu√≠da!</strong> Pontua√ß√£o de precis√£o: ${Math.round(analysisScore)}/50. B√≥nus por bugs: ${bugBonus}/50.`);
            reportSection.classList.remove('d-none');
        });
        
        helpBtn.addEventListener('click', () => helpModal.show());
        
        function registrarLog(mensagem, tipo = 'info') {
            if (logEl.innerHTML.includes('Aguardando')) logEl.innerHTML = '';
            const entry = document.createElement('div');
            entry.className = `log-entry p-2 mb-2 rounded`;
            if (tipo === 'success') entry.classList.add('log-success');
            if (tipo === 'fail') entry.classList.add('log-fail');
            entry.innerHTML = `<small class="text-muted">${new Date().toLocaleTimeString()}</small><br>${mensagem}`;
            logEl.prepend(entry);
        }

        generatePdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            const studentName = localStorage.getItem('studentName') || 'aluno';
            const studentClass = localStorage.getItem('studentClass') || 'turma';
            const score = {
                analysis: Math.round((document.querySelectorAll('.correct-guess').length / 40) * 50),
                bonus: principalBugs.filter(bug => document.querySelector(`select[data-old='${bug.oldF}'][data-new='${bug.newF}']`)?.value === 'ALTA').length * 10,
            };
            score.total = score.analysis + score.bonus;

            // Cabe√ßalho do PDF
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text("Relat√≥rio de An√°lise de Risco - TSOF", 148.5, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text("Evento: An√°lise de Risco: E-commerce", 148.5, 25, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Aluno(a): ${studentName}`, 14, 35);
            doc.text(`Turma: ${studentClass}`, 14, 40);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 45);

            // Pontua√ß√£o
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text(`Pontua√ß√£o Total: ${score.total} / 100`, 280, 35, { align: 'right' });
            
            // Tabela de An√°lise
            doc.setFontSize(11);
            doc.text("Matriz de An√°lise de Risco Preenchida:", 14, 60);
            const tableHead = [['Funcionalidade Antiga', 'M1', 'M2', 'M3', 'M4', 'M5']];
            const tableBody = [];
            oldFeatures.forEach(oldF => {
                const rowData = [oldF.name];
                newFeatures.forEach(newF => {
                    const select = document.querySelector(`select[data-old='${oldF.id}'][data-new='${newF}']`);
                    rowData.push(select ? select.value : '');
                });
                tableBody.push(rowData);
            });
            doc.autoTable({
                head: tableHead, body: tableBody, startY: 65, theme: 'striped',
                headStyles: { fillColor: [17, 34, 64], textColor: 255 },
                styles: { textColor: [20, 20, 20], font: 'helvetica', halign: 'center', cellPadding: 2 },
                columnStyles: { 0: { halign: 'left' } },
                didDrawCell: (data) => {
                    if (data.section === 'body' && data.column.index > 0) {
                        const select = document.querySelector(`select[data-old='${oldFeatures[data.row.index].id}'][data-new='${newFeatures[data.column.index - 1]}']`);
                        if (select && select.value) {
                            if (select.classList.contains('correct-guess')) doc.setFillColor(16, 185, 129); 
                            else doc.setFillColor(239, 68, 68);
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                        }
                    }
                }
            });
            let finalY = doc.lastAutoTable.finalY;

            // Resumo da Pontua√ß√£o
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text("Resumo da Pontua√ß√£o:", 14, finalY + 10);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`- Precis√£o da Matriz: ${score.analysis} / 50 pts`, 16, finalY + 17);
            doc.text(`- Bugs Principais Identificados: ${score.bonus / 10}/${principalBugs.length} (${score.bonus} / 50 pts)`, 16, finalY + 22);
            
            const filename = `tsof_aula07_ecommerce_${studentName.toLowerCase().replace(/ /g, '_')}.pdf`;
            doc.save(filename);
        });

        // Inicializa√ß√£o
        createRiskMatrix();
    </script>
</body>
</html>
